#!/bin/bash

## Copyright (C) 2012 - 2025 ENCRYPTED SUPPORT LLC <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -e

source /usr/share/bootclockrandomization/shared

do_start () {
   log "Boot Clock Randomization"
   log "https://www.kicksecure.com/wiki/Boot_Clock_Randomization"

   if [ -e "$FAIL_FILE" ]; then
      rm -f -- "$FAIL_FILE"
   fi
   if [ -e "$SUCCESS_FILE" ]; then
      rm -f -- "$SUCCESS_FILE"
   fi

   ## Lower in Qubes Template.
   ## Because sdwdate (or other time fixing mechanism) does not yet run in Template.
   ## https://forums.whonix.org/t/whonix-ws-16-template-fails-to-update-due-to-timing-issue/12739/31
   if test -f /run/qubes/this-is-templatevm ; then
      : ${delay_plus_or_minus:="1"}
   fi
   : ${delay_plus_or_minus:="180"}

   get_random_time

   ## Set new time. Syntax: LC_ALL=C date --set @1396733199.112834496
   LC_ALL=C date --set "@$NEW_TIME.$NANOSECONDS" > /dev/null

   ## Testing the `date` syntax:
   ## sudo LC_ALL=C date --set @1396733199.112834496 ; LC_ALL=C date +%s.%N
   ## Sat Apr  5 21:26:39 UTC 2014
   ## 1396733199.114119019
   ## sudo LC_ALL=C date --set @1396733199.112834496 ; LC_ALL=C date +%s.%N
   ## Sat Apr  5 21:26:39 UTC 2014
   ## 1396733199.114122807

   log "Changed time from $OLD_TIME ($OLD_TIME_NANOSECONDS)"
   log "               to $(LC_ALL=C date) ($(LC_ALL=C date +%s.%N))."

   touch -- "$SUCCESS_FILE"
   return 0
}

do_start

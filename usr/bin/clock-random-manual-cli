#!/bin/bash

## Copyright (C) 2012 - 2025 ENCRYPTED SUPPORT LLC <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

## test:
## printf '%s\n' "Fri Sep  30 22:20:00 UTC 2016" | /usr/bin/clock-random-manual-cli

set -e

## provides: get_random_time
source /usr/bin/bootclockrandomization

delay_plus_or_minus="30"

printf '%s\n' "Enter current date. Example:
Fri Sep  30 22:20:00 UTC 2016"

read -r date_input_user

## Example date_input:
## Fri Sep  30 22:20:00 UTC 2016

date_input_unixtime="$(LC_ALL=C date --date "$date_input_user" +%s)"

printf '%s\n' "input: $date_input_user 000000000"

OLD_TIME="$date_input_unixtime"

get_random_time

printf '%s\n' "output: $NEW_TIME_HUMAN $NANOSECONDS"

## Set new time. Syntax: LC_ALL=C date --set @1396733199.112834496
LC_ALL=C date --set "@$NEW_TIME.$NANOSECONDS" > /dev/null

printf '%s\n' "Success, clock is now randomized. Syncing hardware clock..."

## Sync hardware clock with system clock.
hwclock --systohc

printf '%s\n' "Done."
